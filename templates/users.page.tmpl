{{template "admin" .}}

{{define "css"}}
<link rel="stylesheet" href="/static/css/card-layout.css">
<style>
    .upload {
        position: absolute;
        top: 0;
        left: 0;
        width: 40%;
        height: 100%;
        opacity: 0;
        z-index: 3;
    }
</style>

{{end}}

{{define "content"}}
{{$users := index .Data "users" }}
<div class="container">
    <div class="card mb-5 mb-lg-10">
        <div class="card-header">
            <div class="card-title d-flex flex-column justify-content-center">
                <h4>用户管理</h4>
            </div>
            <div class="card-toolbar">
                <!-- <a href="#" class="btn btn-sm btn-primary my-1">添加</a> -->
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-md">
                    <thead>
                        <tr>
                            <th scope="col">#ID</th>
                            <th scope="col">用户名</th>
                            <th scope="col">邮箱</th>
                            <th scope="col">头像</th>
                            <th scope="col">管理员</th>
                            <th scope="col">状态</th>
                            <th scope="col">#操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range $users}}
                        <tr>
                            <td>{{.ID}}</td>
                            <td>{{.Username}}</td>
                            <td>{{.Email}}</td>
                            <td><img src="{{imageURL .Avatar}}" alt="头像" width="32" height="32"></td>
                            <td>{{ifAdminF .IfAdmin}}</td>
                            <td>{{getActive .Active}}</td>
                            <td>
                                <button type="button" class="btn btn-link" data-bs-toggle="modal"
                                    data-bs-target="#editModal"
                                    onclick='openDialog("{{.ID}}","{{.Username}}","{{.Email}}","{{imageURL .Avatar}}","{{.IfAdmin}}")'>
                                    编辑
                                </button>

                                <button type="button" class="btn btn-link text-danger" data-bs-toggle="modal"
                                    data-bs-target="#deleteConf" onclick='deleteUser("{{.ID}}")'>删除</button>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>



<div class="modal fade" id="editModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
    aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">修改用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="" method="POST" class="form-signin border rounded shadow m-3"
                    enctype="multipart/form-data" novalidate>
                    {{.Data.csrfField}}
                    <div class="p-3">
                        <label for="email" class="form-label mb-1 small">邮 箱:</label>
                        <input type="email" readonly name="email" id="email" class="form-control">
                    </div>
                    <div class="p-3">
                        <label for="username" class="form-label mb-1 small">用户名:</label>
                        <input type="text" name="username" id="username" class="form-control" placeholder="">
                    </div>
                    <div class="p-3" style="position: relative;">
                        <label for="avatar" class="form-label mb-1 small">头像:</label>
                        <input type="text" hidden name="avatar">
                        <input type="file" name="file" id="file" accept="image/*" class="form-control upload">
                        <img src="" name="avatar" id="user_avatar" alt="" width="48" height="48"
                            class="rounded-circle me-2">
                    </div>
                    <div class="checkbox p-3 d-flex justify-content-between">
                        <label class="small d-flex justify-content-center align-items-center">
                            是否管理员: &nbsp; <input type="checkbox" name="if_admin">
                        </label>
                    </div>
                    <button class="btn btn-lg btn-primary p-0" style="width:0; height:0; border: none;" type="submit"
                        id="submit"></button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="onSubmit()">保存</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConf" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="deleteConf" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConf">提示</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-danger ps-5">
                确定删除此用户？
            </div>
            <div class="modal-footer">
                <button type="button" data-bs-dismiss="modal" class="btn btn-primary" id="deleteOk">确定</button>
            </div>
        </div>
    </div>
</div>


{{end}}


{{define "js"}}
<script>
    function onSubmit() {
        var subEle = document.getElementById("submit")
        subEle.click()
    }

    function openDialog(id, username, email, avatar, if_admin) {
        var form = document.querySelector("form")
        form.action = "/admin/users/" + id
        form.elements.email.value = email
        form.elements.username.value = username
        form.elements.avatar.value = avatar
        form.elements.if_admin.checked = if_admin > 0 ? true : false

        document.getElementById("user_avatar").src = avatar
    }

    document.getElementById("file").addEventListener("change", function (event) {
        var imageUrl = getObjectURL(event.target.files[0])
        document.getElementById("user_avatar").src = imageUrl
    })

    function getObjectURL(file) {
        var url = null;
        if (window.createObjectURL != undefined) {
            url = window.createObjectURL(file);
        } else if (window.URL != undefined) {
            url = window.URL.createObjectURL(file);
        } else if (window.webkitURL != undefined) {
            url = window.webkitURL.createObjectURL(file);
        }
        return url;
    }

    var deleteID = null
    function deleteUser(id) {
        deleteID = id
    }

    // 执行删除
    document.getElementById("deleteOk").addEventListener("click", function () {
        var aEl = document.createElement("a")
        aEl.href = "/admin/users/" + deleteID
        aEl.click()
        deleteID = null
    })

</script>
{{end}}